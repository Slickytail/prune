<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script src="https://dglittle.github.io/cdn/random001.js"></script>
        <script src="https://dglittle.github.io/cdn/utils004.js"></script>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="./sync9.js"></script>
        <script src="./sync9_peer.js"></script>
        <script src="./trial.js"></script>
        <script>
        function begin() {
            var nodes = [];
            var links = [];
            var trial = new Trial({
                timing: 30,
                peers: 4});
            trial.on("tick", update_links);
            trial.begin();

            function update_links(peers) {
                let nodes_old_len = nodes.length;
                let links_old_len = links.length;
                let nodes_new = Object.keys(peers).map(vid => {
                    let node = {id: vid}
                    for (var peer of nodes) {
                        if (peer.id == vid) {
                            node.x = peer.x;
                            node.y = peer.y;
                            break;
                        }
                    }
                    return node;
                })
                links = [];
                var seen_peers = new Set();
                function add_links(peer) {
                    if (seen_peers.has(peer))
                        return;
                    seen_peers.add(peer);
                    for (var link of Object.keys(peers[peer].peers)) {
                        links.push({source: peer, target: link})
                        add_links(link)
                    }
                }
                add_links(Object.keys(peers)[0]);

                if (nodes_new.length != nodes_old_len) {
                    nodes = nodes_new;
                    simulation.nodes(nodes);
                }
                if (links.length != links_old_len) {
                    simulation.force("link").links(links);
                }
                if (nodes.length != nodes_old_len || links.length != links_old_len) {
                    update_graphics();
                }
            }

            function update_graphics() {
                node = node.data(nodes, d => d.id);
                node.exit().remove();
                node = node.enter().append("circle").attr("fill", "#333").attr("r", 6).merge(node);

                // Apply the general update pattern to the links.
                link = link.data(links, d => d.source.id + "-" + d.target.id);
                link.exit().remove();
                link = link.enter().append("line").merge(link);

                simulation.alpha(0.2).restart();
            }

            var size = Math.min(document.body.clientWidth, document.body.clientHeight);
            const svg = d3.select("svg")
                          .attr("width", size)
                          .attr("height", size)
            
            var link = svg.append("g").attr("stroke", "#222").attr("stroke-width", 1.5).selectAll(".link"),
                node = svg.append("g").attr("stroke", "#aaa").attr("stroke-width", 1.5).selectAll(".node");

            const simulation = d3.forceSimulation()
                .force("link", d3.forceLink(links)
                                 .id(d => d.id)
                                 .distance(150))
                .force("repel", d3.forceManyBody()
                                   .strength(-1000)
                                   .distanceMax(200))
                .force("center", d3.forceCenter(size/2, size/2));

            update_graphics();

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
            });

        }
        
        if (document.readyState === "complete" ||
            (document.readyState !== "loading" && !document.documentElement.doScroll)) {
            begin();
        } else {
            document.addEventListener("DOMContentLoaded", begin);
        }
        </script>
    </head>
    <body>
        <svg width=800 height=500></svg>
    </body>
</html>